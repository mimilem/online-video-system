"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_require=require("./jquery-ports"),width=_require.width,height=_require.height,isNumeric=_require.isNumeric,isFunction=_require.isFunction,selectAll=_require.selectAll,remove=_require.remove,addClass=_require.addClass,removeClass=_require.removeClass,cssObjAssign=_require.cssObjAssign,cloneNode=_require.cloneNode,outerHeight=_require.outerHeight,showElement=_require.showElement,hideElement=_require.hideElement,toggleElement=_require.toggleElement,validPositions=new Set(["right","left"]),noop=function(){},propValidators={allowClick:function(e){if(e!==!0&&e!==!1)throw new Error("Invalid allowClick: "+e)},fadeHover:function(e){if(e!==!0&&e!==!1)throw new Error("Invalid fadeHover: "+e)},hoverOpacity:function(e){if(!isNumeric(e)||e<=0||e>1)throw new Error("Invalid hoverOpacity: "+e)},disableFind:function(e){if(e!==!0&&e!==!1)throw new Error("Invalid disableFind: "+e)},heightRatio:function(e){if(!isNumeric(e)||e<=0||e>1)throw new Error("Invalid heightRatio: "+e)},widthRatio:function(e){if(!isNumeric(e)||e<=0||e>.5)throw new Error("Invalid widthRatio: "+e)},offsetHeightRatio:function(e){if(!isNumeric(e)||e<0||e>.9)throw new Error("Invalid offsetHeightRatio: "+e)},offsetWidthRatio:function(e){if(!isNumeric(e)||e<0||e>.9)throw new Error("Invalid offsetWidthRatio: "+e)},position:function(e){if(!validPositions.has(e))throw new Error("Invalid position: "+e)},smoothScrollDelay:function(e){if((0|e)!==e||e<4)throw new Error("Invalid smoothScrollDelay(in ms): "+e)},touch:function(e){},smoothScroll:function(e){},onPreviewChange:function(e){if(!e||!isFunction(e))throw new Error("Invalid onPreviewChange: "+e)}},minimap=function(){function e(t,n){_classCallCheck(this,e),this.baseElement=t,this.shown=!1,this.mousedown=!1,this.onSmoothScroll=!1,this.lastTouchType="";var i={allowClick:!0,fadeHover:!1,hoverOpacity:.4,heightRatio:.6,widthRatio:.05,offsetHeightRatio:.035,offsetWidthRatio:.035,position:"right",touch:!0,smoothScroll:!0,smoothScrollDelay:200,onPreviewChange:noop,disableFind:!1},o=this.settings=Object.assign({},i,n);o.position=o.position.toLowerCase(),this._validateProps(o),console.log(o);var s=this.miniElement=cloneNode(t);remove(selectAll(".minimap .noselect",s)),remove(selectAll(".miniregion",s)),addClass(s,"minimap noselect");var r=s.children,l=void 0;if(o.disableFind===!0)for(var a=0;a<r.length;a++)l=r[a],addClass(l,"unsearchable");for(var h=0;h<r.length;h++)l=r[h],cssObjAssign(l,{"pointer-events":"none"});var d=this.region=document.createElement("div");addClass(d,"miniregion");var c=document.body;c.appendChild(d),c.appendChild(s),console.log(d),this._disableFind(selectAll(".unsearchable"));var u=this.onScrollHandler=this._genOnScrollHandler(),v=this.onResizeHandler=this._genOnResizeHandler();if(v(),window.addEventListener("resize",v),window.addEventListener("scroll",u),o.allowClick){var m=this.onMouseUpHandler=this._genOnMouseUpHandler(),f=this.onMouseMoveHandler=this._genOnMouseMoveHandler(),g=this.onMouseDownHandler=this._genOnMouseDownHandler(),w=this.onClickHandler=this._genOnClickHandler();document.addEventListener("mouseup",m),document.addEventListener("mousemove",f),d.addEventListener("mousedown",g),d.addEventListener("mouseup",m),d.addEventListener("mousemove",f),d.addEventListener("click",w),s.addEventListener("mousedown",g),s.addEventListener("mouseup",m),s.addEventListener("mousemove",f),s.addEventListener("click",w)}if(o.touch){var p=this.touchHandler=this._genTouchHandler();document.addEventListener("touchstart",p,!0),document.addEventListener("touchmove",p,!0),document.addEventListener("touchend",p,!0),document.addEventListener("touchcancel",p,!0)}if(o.fadeHover){console.log("adding fade on hover listeners");var y=this.settings.hoverOpacity;s.addEventListener("mouseover",function(){console.log("mouse over"),s.style.opacity=""+y,s.style.filter="alpha(opacity="+100*y+")",d.style.opacity=""+y,d.style.filter="alpha(opacity="+100*y+")"}),s.addEventListener("mouseout",function(){console.log("mouse out"),s.style.opacity=null,s.style.filter=null,d.style.opacity=null,d.style.filter=null})}}return _createClass(e,[{key:"_genOnResizeHandler",value:function(){var e=this;return function(t){if(e.shown){var n=e.settings,i=e._scale(),o="scale("+i.x+","+i.y+")",s=height(window)*n.offsetHeightRatio,r=width(window)*n.offsetWidthRatio,l=height(e.baseElement)*(i.y-1)/2+s,a=width(e.baseElement)*(i.x-1)/2+r,h=width(window)*(1/i.x)*n.widthRatio,d=height(window)*(1/i.y)*n.heightRatio,c={"-webkit-transform":o,"-moz-transform":o,"-ms-transform":o,"-o-transform":o,transform:o,top:l+"px",width:h+"px",height:d+"px",margin:"0px",padding:"0px"};c[n.position]=a+"px";var u=e.baseElement.offsetTop*i.y,v={width:width(e.miniElement)+"px",height:height(window)*i.y+"px",margin:"0px",top:window.scrollY*i.y+s-u+"px"};v[e.settings.position]=r+"px",cssObjAssign(e.region,v),cssObjAssign(e.miniElement,c),e.settings.onPreviewChange(e.miniElement,i)}}}},{key:"_genOnScrollHandler",value:function(){var e=this;return function(t){if(e.shown){var n=e._scale(),i=height(window)*e.settings.offsetHeightRatio,o=e.baseElement.offsetTop*n.y,s=window.scrollY*n.y,r=outerHeight(e.region),l=outerHeight(e.baseElement)*n.y+o;s+r+i<o||s>l?cssObjAssign(e.region,{display:"none"}):cssObjAssign(e.region,{top:i+s+"px",display:"block"})}}}},{key:"_genOnMouseUpHandler",value:function(){var e=this;return function(t){e.mousedown=!1,removeClass(e.baseElement,"noselect"),removeClass(e.region,"dragging")}}},{key:"_genOnMouseMoveHandler",value:function(){var e=this;return function(t){e.mousedown&&!e.onSmoothScroll&&e.scrollTop(t)}}},{key:"_genOnMouseDownHandler",value:function(){var e=this;return function(t){e.mousedown=!0,addClass(e.baseElement,"noselect"),addClass(e.region,"dragging")}}},{key:"_genOnClickHandler",value:function(){var e=this;return function(t){e.scrollTop(t),e.mousedown=!1}}},{key:"_genTouchHandler",value:function(){var e=this;return function(t){var n=t.changedTouches;if(!(n.length>1)){var i=n[0],o=["touchstart","touchmove","touchend"],s=["mousedown","mousemove","mouseup"],r=o.indexOf(t.type);if(r!==-1){var l=s[r];t.type===o[2]&&e.lastTouchType===o[0]&&(l="click");var a=document.createEvent("MouseEvent");a.initMouseEvent(l,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(a),t.preventDefault(),e.lastTouchType=t.type}}}}},{key:"scrollTop",value:function(e){if(this.shown){var t=this._scale(),n=height(window)*this.settings.offsetHeightRatio,i=this.baseElement.offsetTop*t.y,o=outerHeight(this.region),s=(e.clientY-o/2-n+i)/t.y;if("click"===e.type&&this.settings.smoothScroll){var r=window.scrollY,l=outerHeight(this.baseElement);s=Math.max(s,Math.min(s,l));var a=s>r,h=this.settings.smoothScrollDelay,d=Math.abs(r-s),c=h/d,u=1,v=4;this.onSmoothScroll=!1,c>=4?v=parseInt(u):u=c>=1?4*parseInt(c):4/c;var m=r,f=parseInt(d/u);this.onSmoothScroll=!0;var g=function(){m+=a?u:-u,--f<=0&&(clearInterval(w),this.onSmoothScroll=!1,m=s);var e=window.scrollX;window.scrollTo(e,m)},w=window.setInterval(g,v)}else{var p=window.scrollX;window.scrollTo(p,s)}e.stopPropagation()}}},{key:"_disableFind",value:function(e){e.forEach(function(e){for(var t="",n=!1,i=e,o=i.innerHTML,s=0;s<o.length;s++)t+=o[s],"<"===o[s]&&(n=!0),">"===o[s]&&(n=!1),n===!1&&(t+='<span style="position:absolute; right:-999999999px;">.</span>')," "===o[s]&&(t+=" ");i.innerHTML=t})}},{key:"_validateProps",value:function(e){var t=Object.keys(e),n=!0,i=!1,o=void 0;try{for(var s,r=t[Symbol.iterator]();!(n=(s=r.next()).done);n=!0){var l=s.value,a=propValidators[l];if(!a)throw new Error("Invalid validation property: "+e[l]);a(e[l])}}catch(e){i=!0,o=e}finally{try{!n&&r.return&&r.return()}finally{if(i)throw o}}}},{key:"_scale",value:function(){return{x:width(window)/width(this.baseElement)*this.settings.widthRatio,y:height(window)/height(this.baseElement)*this.settings.heightRatio}}},{key:"setPosition",value:function(e){var t=this.settings.position,n=propValidators.position;if(n(e),this.settings.position=e,t!==this.settings.position){var i={};i[t]="",this.onResizeHandler(),cssObjAssign(this.region,i),cssObjAssign(this.miniElement,i)}}},{key:"_genSetPropertyFunction",value:function(e,t){var n=this;return function(i){var o=propValidators[e];o(e,i),n.settings[e]=i,t&&n.onResizeHandler()}}},{key:"show",value:function(){this.shown||(showElement(this.miniElement),showElement(this.region),this.shown=!0,this.onResizeHandler())}},{key:"hide",value:function(){this.shown&&(hideElement(this.miniElement),hideElement(this.region),this.shown=!1)}},{key:"toggle",value:function(){toggleElement(this.miniElement),toggleElement(this.region),this.shown=!this.shown,this.shown&&this.onResizeHandler()}}]),e}();module.exports=minimap;